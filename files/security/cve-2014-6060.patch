From a3164eb2cb737ec900945d703f954d36dcca3d0a Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@evolve-os.com>
Date: Thu, 11 Sep 2014 23:52:33 +0100
Subject: [PATCH] dhcp: Backport fix from 6.4.3 for CVE-2014-6060

The get_option function in dhcpcd 4.0.0 through 6.x before 6.4.3 allows remote
DHCP servers to cause a denial of service by resetting the
DHO_OPTIONSOVERLOADED option in the (1) bootfile or (2) servername section,
which triggers the option to be processed again.

---
Backported from upstream commit

Signed-off-by: Ikey Doherty <ikey@evolve-os.com>
---
 dhcp.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/dhcp.c b/dhcp.c
index 6a08cf0..5e1cf7f 100644
--- a/dhcp.c
+++ b/dhcp.c
@@ -354,9 +354,12 @@ get_option(const struct dhcp_message *dhcp, uint8_t opt, int *len, int *type)
 				goto exit;
 			break;
 		case DHO_OPTIONSOVERLOADED:
-			/* Ensure we only get this option once */
+			/* Ensure we only get this option once by setting
+			 * the last bit as well as the value.
+			 * This is valid because only the first two bits
+			 * actually mean anything in RFC2132 Section 9.3 */
 			if (!overl)
-				overl = p[1];
+				overl = 0x80 | p[1];
 			break;
 		}
 		l = *p++;
-- 
1.8.4

